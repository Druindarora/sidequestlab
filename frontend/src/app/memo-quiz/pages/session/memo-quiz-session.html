<div class="mq-session page">
  @if (phase !== 'DONE') {
    <mat-card class="mq-session-card mq-session-card--fixed">
      <mat-card-header>
        <div class="mq-session-header">
          <div class="mq-session-title">
            <mat-card-title>Session de révision</mat-card-title>
            @if (currentCard) {
              <mat-card-subtitle>
                <mat-chip-set aria-label="Infos carte">
                  <mat-chip>Boîte {{ currentCard.box }}</mat-chip>
                </mat-chip-set>
              </mat-card-subtitle>
            }
          </div>
          <div class="mq-session-progress">
            <div class="mq-session-counter">{{ currentNumber }} / {{ total }}</div>
          </div>
        </div>
      </mat-card-header>
      <mat-card-content>
        @if (errorMessage) {
          <div class="mq-session-alert mq-session-alert--error">
            {{ errorMessage }}
          </div>
        }
        <mat-progress-bar
          [mode]="loading ? 'indeterminate' : 'determinate'"
          [value]="progressPercent"
          aria-label="Progression de la session"
        ></mat-progress-bar>
        <div class="mq-session-scroll">
          @if (currentCard) {
            <div class="mq-session-body">
              <div class="mq-question">
                <div class="mq-label">Question</div>
                <div class="mq-text mq-text--question">
                  {{ currentCard.question }}
                </div>
              </div>
              <mat-divider></mat-divider>
              @if (phase === 'ANSWER') {
                <div class="mq-answer">
                  <div class="mq-label">Réponse</div>
                  <div class="mq-text mq-text--answer">
                    {{ currentCard.answer }}
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="mq-empty">Aucune carte à réviser aujourd’hui (mock).</div>
          }
        </div>
      </mat-card-content>
      <mat-card-actions align="end" class="mq-session-actions mq-session-actions--sticky">
        <!-- Phase QUESTION : afficher la réponse -->
        @if (phase === 'QUESTION') {
          <button
            mat-flat-button
            color="primary"
            (click)="revealAnswer()"
            [disabled]="loading || !currentCard"
            >
            Afficher la réponse
          </button>
        }
        <!-- Phase ANSWER : ✅ / ❌ -->
        @if (phase === 'ANSWER') {
          <button
            mat-flat-button
            color="primary"
            class="mq-answer-btn mq-answer-btn--good"
            (click)="markAnswer(true)"
            aria-label="J’ai bien répondu"
            [disabled]="loadingAnswer || !currentCard"
            >
            <mat-icon>check</mat-icon>
            J’ai bon
          </button>
          <button
            mat-stroked-button
            color="warn"
            class="mq-answer-btn mq-answer-btn--bad"
            (click)="markAnswer(false)"
            aria-label="Je me suis trompé"
            [disabled]="loadingAnswer || !currentCard"
            >
            <mat-icon>close</mat-icon>
            J’ai faux
          </button>
        }
      </mat-card-actions>
    </mat-card>
  }

  <!-- FIN : mini récap -->
  @if (phase === 'DONE') {
    <mat-card class="mq-session-card">
      <mat-card-header>
        <mat-card-title>Session terminée</mat-card-title>
        <mat-card-subtitle>Récapitulatif</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="mq-recap">
          <div class="mq-recap-item">
            <div class="mq-recap-label">Bonnes réponses</div>
            <div class="mq-recap-value">{{ goodCount }}</div>
          </div>
          <div class="mq-recap-item">
            <div class="mq-recap-label">Mauvaises réponses</div>
            <div class="mq-recap-value">{{ badCount }}</div>
          </div>
          <div class="mq-recap-item">
            <div class="mq-recap-label">Total</div>
            <div class="mq-recap-value">{{ total }}</div>
          </div>
        </div>
      </mat-card-content>
      <mat-card-actions align="end">
        <button mat-flat-button color="primary" (click)="backToDashboard()">
          Retour au dashboard
        </button>
      </mat-card-actions>
    </mat-card>
  }
</div>
